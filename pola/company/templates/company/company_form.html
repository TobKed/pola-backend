{%extends 'company/base.html' %}

{% load crispy_forms_tags i18n %}

{% block css %}
    {{ block.super }}
    <style>
        /* Will be set dynamically based on actual sticky height */
        :root { --sticky-height: 0px; }
        /* Ensure the action bar is always visible and spans full width */
        .sticky {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1030; /* above content, below modals */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 16px;
            min-height: var(--sticky-height);
            background: #fff;
            border-top: 1px solid #e5e5e5;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
        }
        /* Spacer so last form fields aren’t hidden under the bar */
        .sticky-spacer { height: var(--sticky-height); }
    </style>
{% endblock %}

{% block breadcrumbs_rows %}
    {% if object %}
        <li><a href="{{ object.get_absolute_url }}">{{ object }}</a></li>
        <li class="active">{% trans 'Zmień' %}</li>
    {% else %}
        <li class="active">{% trans 'Dodaj' %}</li>
    {% endif %}
{% endblock %}

{% block content %}
    <form
        id="company-form"
        method="POST"
        action="{{ form.helper.form_action }}"
        {% if form.is_multipart %} enctype="multipart/form-data"{% endif %}>
        <div class="form-horizontal">
            {% crispy form %}
        </div>
        <div class="brand-formset clearfix">
            {% crispy brand_formset brand_formset_helper %}
            <div class="pull-right">
                <button class="btn add-row" type="button">Add new row</button>
            </div>
        </div>
        <div class="form-horizontal">
            <div class="form-group">
                <div class="aab controls col-lg-3"></div>
                <div class="controls col-lg-9">
                    <div class="sticky">
                        <input type="submit" name="action" value="Save" class="btn btn-primary" id="submit-id-action">
                        <input type="reset" name="reset" value="Przywróć poprzednie" class="btn btn-inverse" id="reset-id-reset">
                    </div>
                    <div class="sticky-spacer" aria-hidden="true"></div>
                </div>
            </div>
        </div>
    </form>
{% endblock content %}

{% block javascript %}
    {% if not form.instance.description  %}
    <script>
    $( document ).ready(function() {
        $('#div_id_description label').after("<a href='#' onClick ='copy_desc(event);'>Kopiuj</a>")
    });

    function copy_desc(event)
    {
        event.preventDefault();
        $('#div_id_description textarea').text(
                '{{ form.instance.js_plCapital_notes }}\n'+
                '{{ form.instance.js_plWorkers_notes }}\n'+
                '{{ form.instance.js_plRnD_notes }}\n'+
                '{{ form.instance.js_plRegistered_notes }}\n'+
                '{{ form.instance.js_plNotGlobEnt_notes }}'
        )
        $('#div_id_commit_desc textarea').text('Nowy opis firmy na podstawie opisów w poprzednim formacie')
    }
    </script>
    {% endif %}
    <script>
    // Keep the spacer height in sync with the actual sticky bar height
    (function() {
        function updateStickyHeight() {
            var $sticky = $('.sticky');
            if (!$sticky.length) return;
            var h = $sticky.outerHeight();
            document.documentElement.style.setProperty('--sticky-height', h + 'px');
        }

        // Initial calculation on DOM ready
        $(updateStickyHeight);
        // Recalculate on window resize
        $(window).on('resize', updateStickyHeight);
        // Recalculate if sticky content size changes
        if (window.ResizeObserver) {
            var el = document.querySelector('.sticky');
            if (el) {
                var ro = new ResizeObserver(updateStickyHeight);
                ro.observe(el);
            }
        }
        // Final pass after assets load (fonts, etc.)
        $(window).on('load', updateStickyHeight);
    })();

    $('.brand-formset').each(function() {
        const $formset = $(this);
        const $addButton = $formset.find('.add-row');
        const $template = $formset.find('.empty-form').clone();
        const $rowsContainer = $formset.find('.empty-form').parent()
        const $totalForms = $formset.find('input[name$=TOTAL_FORMS]');

        console.log({$formset, $addButton, $template, $rowsContainer})
        $template.removeClass('hidden empty-form')
        $addButton.click(function () {
            const $newRow = $template.clone();
            // -1 because of the empty form
            const formCount = $rowsContainer.children().length - 1;
            $newRow.find('input, select, textarea, td').each(function () {
                const $el = $(this);
                ['name', 'id'].forEach(function (attr) {
                    const value = $el.attr(attr);
                    if (value) {
                        $el.attr(attr, value.replace('__prefix__', formCount));
                    }
                });
            });
            $rowsContainer.append($newRow);
            // +1 because of the added form
            $totalForms.val(formCount + 1);
        });
    })

    </script>
{% endblock %}
